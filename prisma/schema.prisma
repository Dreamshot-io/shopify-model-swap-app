// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  shopId         String?
  shopCredential ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@index([shopId])
}

enum ShopCredentialStatus {
  ACTIVE
  DISABLED
}

enum ShopCredentialMode {
  PUBLIC
  PRIVATE
}

model ShopCredential {
  id           String               @id @default(cuid())
  shopDomain   String
  shopName     String? // Store name from Shopify (denormalized for dashboard)
  apiKey       String
  apiSecret    String
  appHandle    String
  appUrl       String
  apiVersion   String               @default("January25")
  scopes       String[]
  distribution String?              @default("AppStore")
  customDomain String?
  redirectUrls String[]             @default([])
  metadata     Json?
  status       ShopCredentialStatus @default(ACTIVE)
  mode         ShopCredentialMode   @default(PUBLIC)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  sessions               Session[]
  abTests                ABTest[]
  auditLogs              AuditLog[]
  metricEvents           MetricEvent[]
  productRules           ProductSuggestionRule[]
  generations            GenerationHistory[]
  aiStudioImages         AIStudioImage[]
  statisticsExports      StatisticsExport[]
  productInfo            ProductInfo[]
  variantDailyStatistics VariantDailyStatistics[]
  abTestEvents           ABTestEvent[]

  @@unique([shopDomain, apiKey])
  @@index([shopDomain])
  @@index([apiKey])
  @@index([status])
  @@index([mode])
}

// Core A/B Test model - simplified structure
model ABTest {
  id           String @id @default(cuid())
  shop         String
  productId    String
  name         String
  status       String @default("DRAFT") // DRAFT, ACTIVE, PAUSED, COMPLETED, MIGRATING
  trafficSplit Int    @default(50)

  // Legacy image storage - will be deprecated
  baseImages Json // JSON array of base case images
  testImages Json // JSON array of test case images

  // New gallery-based image storage
  baseMediaIds String[] @default([]) // Array of Shopify media IDs
  testMediaIds String[] @default([]) // Array of Shopify media IDs

  // Rotation management
  currentCase   String    @default("BASE") // BASE or TEST
  rotationHours Float     @default(0.5) // Hours between rotations (0.5 = 30 minutes)
  lastRotation  DateTime?
  nextRotation  DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String // User who created the test

  // Legacy fields (kept for data compatibility)
  hypothesis String?
  priority   Int?
  testType   String?

  // Relations
  mediaRecords   TestMedia[]
  variants       ABTestVariant[]
  events         ABTestEvent[]
  auditLogs      AuditLog[]
  rotationEvents RotationEvent[]

  shopId         String?
  shopCredential ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@index([shop, status])
  @@index([shop, productId])
  @@index([nextRotation])
  @@index([shopId])
}

// Media tracking for gallery-based system
model TestMedia {
  id       String  @id @default(cuid())
  testId   String
  mediaId  String // Shopify media GID
  testCase String // BASE or TEST
  position Int
  url      String // For display/reference
  altText  String?

  // Migration tracking
  sourceUrl  String? // Original R2 URL if migrated
  migratedAt DateTime? // When migrated from R2

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, mediaId])
  @@index([testId, testCase])
}

// Variant-specific test configuration (for hero images)
model ABTestVariant {
  id               String @id @default(cuid())
  testId           String
  shopifyVariantId String // Actual Shopify variant ID (e.g., gid://shopify/ProductVariant/123)
  variantName      String // Human-readable name (e.g., "Red / Large")

  // Legacy hero images - will be deprecated
  baseHeroImage Json? // JSON object with image data
  testHeroImage Json // JSON object with test hero image

  // New gallery-based hero images
  baseHeroMediaId String? // Shopify media ID for base hero
  testHeroMediaId String? // Shopify media ID for test hero

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, shopifyVariantId])
  @@index([testId])
}

// Customer event tracking (impressions, conversions, purchases)
model ABTestEvent {
  id         String  @id @default(cuid())
  testId     String? // Nullable - events can be tracked without active test
  sessionId  String
  eventType  String // IMPRESSION, ADD_TO_CART, PURCHASE
  activeCase String? // BASE or TEST (null if no test active)

  // Event details
  productId String
  variantId String? // Shopify variant ID if applicable
  revenue   Decimal? // For PURCHASE events
  quantity  Int? // For ADD_TO_CART and PURCHASE events

  // Shop relation - allows querying events by shop even without test
  shopId String?
  shop   ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  // Context
  metadata  Json? // JSON with additional context (browser, referrer, etc.)
  createdAt DateTime @default(now())

  test ABTest? @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId, eventType, createdAt])
  @@index([testId, sessionId])
  @@index([testId, activeCase])
  @@index([productId, createdAt]) // Index for querying events by product
  @@index([shopId, createdAt]) // Index for querying events by shop
}

// Comprehensive audit logging for all system events
model AuditLog {
  id          String   @id @default(cuid())
  testId      String? // Null for system-wide events
  entityType  String // TEST, ROTATION, SYSTEM, USER_ACTION
  eventType   String // See comprehensive list in implementation
  userId      String? // Who triggered the event (null for system events)
  shop        String
  description String // Human-readable description
  metadata    Json // JSON with detailed event data
  timestamp   DateTime @default(now())

  test ABTest? @relation(fields: [testId], references: [id], onDelete: Cascade)

  shopId         String?
  shopCredential ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@index([testId, timestamp])
  @@index([shop, eventType, timestamp])
  @@index([userId, timestamp])
  @@index([entityType, timestamp])
  @@index([shopId])
}

// Track rotation events specifically for attribution
model RotationEvent {
  id          String  @id @default(cuid())
  testId      String
  fromCase    String // BASE or TEST
  toCase      String // BASE or TEST
  triggeredBy String // CRON, MANUAL, ROLLBACK, SYSTEM
  userId      String? // Who triggered it (if manual)

  // Execution details
  success  Boolean
  error    String? // Error message if failed
  duration Int // Milliseconds to complete

  // Additional context
  metadata  Json? // JSON with GraphQL responses, media IDs changed, etc.
  timestamp DateTime @default(now())

  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId, timestamp])
  @@index([triggeredBy, timestamp])
}

// Track metrics for analytics
model MetricEvent {
  id        String   @id @default(cuid())
  shop      String
  eventType String // GENERATED, DRAFT_SAVED, IMAGE_SELECTED, etc.
  metadata  Json? // JSON object with event-specific data
  timestamp DateTime @default(now())

  // Common fields for AI operations
  model     String? // AI model used
  prompt    String? // Prompt text
  productId String? // Related product
  imageUrl  String? // Generated image URL
  duration  Int? // Operation duration in ms

  shopId         String?
  shopCredential ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@index([shop, eventType])
  @@index([timestamp])
  @@index([shopId])
}

// Product suggestions configuration
model ProductSuggestionRule {
  id          String  @id @default(cuid())
  shop        String
  name        String
  description String?

  // Rule configuration
  sourceField String // product_type, vendor, tag, collection, metafield
  operator    String // equals, contains, starts_with, regex
  value       String // The value to match

  // Suggestion settings
  suggestionPrompt String // Template for AI prompt
  maxSuggestions   Int     @default(3)
  autoApply        Boolean @default(false)

  // Metadata
  isActive  Boolean  @default(true)
  priority  Int      @default(0) // Higher priority rules run first
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shopId         String?
  shopCredential ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@unique([shop, name])
  @@index([shop, isActive, priority])
  @@index([shopId])
}

// AI generation history
model GenerationHistory {
  id        String @id @default(cuid())
  shop      String
  productId String

  // Generation details
  model    String? // AI model used
  prompt   String // Prompt text
  imageUrl String // Generated image URL

  // Metadata
  status    String // pending, completed, failed
  error     String? // Error message if failed
  metadata  Json? // JSON with additional data
  createdAt DateTime @default(now())

  // Legacy fields (kept for data compatibility)
  suggestionId   String?
  inputMetadata  Json?
  outputMetadata Json?
  approvedAt     DateTime? @db.Timestamp(6)
  dismissedAt    DateTime? @db.Timestamp(6)

  shopId         String?
  shopCredential ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@index([shop, productId])
  @@index([createdAt])
  @@index([shopId])
  @@index([suggestionId])
}

// AI Studio image management - replaces metafield storage
model AIStudioImage {
  id        String @id @default(cuid())
  shop      String
  productId String

  // Shopify media reference
  mediaId String? // Shopify media GID when published to gallery
  url     String // Display URL (from AI provider, upload, or Shopify)

  // State management
  state  String // LIBRARY or PUBLISHED
  source String // AI_GENERATED, MANUAL_UPLOAD, GALLERY_IMPORT

  // AI generation metadata (if source = AI_GENERATED)
  prompt         String? // The prompt used to generate this image
  sourceImageUrl String? // Original image URL used as input for AI
  aiProvider     String? // replicate, fal, etc.

  // Variant associations
  variantIds String[] @default([]) // Which variants this image is for

  // Timestamps
  createdAt   DateTime  @default(now())
  publishedAt DateTime? // When it was published to gallery
  updatedAt   DateTime  @updatedAt

  shopId         String?
  shopCredential ShopCredential? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@index([shop, productId])
  @@index([shop, productId, state])
  @@index([createdAt])
  @@index([shopId])
}

// Product info tracking - stores product media metadata and R2 backups
model ProductInfo {
  id        String  @id @default(cuid())
  productId String
  mediaId   String? // Shopify media ID (e.g., gid://shopify/MediaImage/123) - nullable for product-level entries

  // Denormalized product info (for dashboard display)
  productTitle  String? // Product title from Shopify
  productHandle String? // Product handle/slug from Shopify

  // Image URLs
  shopifyUrl String? // Shopify CDN URL - nullable until fetched
  r2Url      String? // R2 permanent URL (null if not yet backed up)
  r2Key      String? // R2 object key: product-images/{shopId}/{productId}/{mediaId}.{ext}

  // Backup metadata
  backedUpAt DateTime? // When image was backed up to R2

  // AI tagging metadata (for future use)
  tags               String[]  @default([])
  taggedAt           DateTime? @db.Timestamptz(6)
  taggingError       String?
  strategicRationale String?

  // Soft delete
  deletedAt DateTime? @db.Timestamptz(6)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopId          String
  shopCredential  ShopCredential           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  dailyStatistics VariantDailyStatistics[]

  @@unique([shopId, mediaId])
  @@index([shopId, productId])
  @@index([deletedAt])
}

// Daily statistics export records
model StatisticsExport {
  id        String   @id @default(cuid())
  productId String
  variantId String
  date      DateTime // UTC date of the export (YYYY-MM-DD)

  // Denormalized names (for dashboard display)
  shopName     String? // Store name
  productTitle String? // Product title
  variantTitle String? // Variant title (e.g., "Red / Large")

  // R2 storage references
  csvR2Key  String // statistic-exports/{shopId}/{productId}/{variantId}/YYYYMMDD.csv
  jsonR2Key String // statistic-exports/{shopId}/{productId}/{variantId}/YYYYMMDD.json
  csvUrl    String // Signed R2 URL for CSV
  jsonUrl   String // Signed R2 URL for JSON

  // Snapshot of metrics at export time (deprecated - use VariantDailyStatistics)
  metricsSnapshot Json? // { impressions, addToCarts, ctr, orders, revenue }
  imagesSnapshot  Json? // Array of { mediaId, shopifyUrl, r2Url, r2Key, backedUpAt }

  // Metadata
  exportedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  shopId         String
  shopCredential ShopCredential          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  statistics     VariantDailyStatistics?

  @@unique([shopId, productId, variantId, date])
  @@index([shopId, date])
  @@index([shopId, productId])
  @@index([date])
}

// Variant daily statistics - queryable metrics data
model VariantDailyStatistics {
  id        String   @id @default(cuid())
  exportId  String   @unique
  productId String
  variantId String
  date      DateTime // UTC date of statistics (YYYY-MM-DD)

  // Denormalized names (for dashboard display)
  shopName     String? // Store name
  productTitle String? // Product title
  variantTitle String? // Variant title (e.g., "Red / Large")

  // Raw metrics
  impressions Int     @default(0)
  addToCarts  Int     @default(0)
  orders      Int     @default(0)
  revenue     Decimal @default(0) @db.Decimal(12, 2)

  // Pre-computed metrics (for query performance)
  ctr            Decimal @default(0) @db.Decimal(10, 6) // addToCarts / impressions
  conversionRate Decimal @default(0) @db.Decimal(10, 6) // orders / impressions

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopId         String
  shopCredential ShopCredential   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  export         StatisticsExport @relation(fields: [exportId], references: [id], onDelete: Cascade)
  productInfo    ProductInfo[] // Product media info for this variant on this date

  @@unique([shopId, productId, variantId, date])
  @@index([shopId, date])
  @@index([productId, date])
  @@index([variantId, date])
  @@index([date])
  @@index([impressions])
  @@index([revenue])
}
