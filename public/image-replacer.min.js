!function(){"use strict";const e=window.location.search.includes("ab_debug=true");function t(...t){e&&console.log("[A/B Test Debug]",...t)}const n="ab_test_session",o="ab_test_active";let i=!1;const s=new Set;function a(){if(t("Attempting product ID detection..."),window.ShopifyAnalytics&&window.ShopifyAnalytics.meta&&window.ShopifyAnalytics.meta.product&&window.ShopifyAnalytics.meta.product.gid){const e=window.ShopifyAnalytics.meta.product.gid;return console.log("[A/B Test] Product ID detected:",e,"(via ShopifyAnalytics)"),e}if(window.__st&&window.__st.rid){const e="gid://shopify/Product/"+window.__st.rid;return console.log("[A/B Test] Product ID detected:",e,"(via __st)"),e}const e=document.querySelector('meta[property="og:product:id"]');if(e&&e.content){const t="gid://shopify/Product/"+e.content;return console.log("[A/B Test] Product ID detected:",t,"(via meta tag)"),t}const n=document.querySelector('form[action*="/cart/add"]');if(n){const e=n.querySelector('input[name="id"]');if(e&&e.value){const t="gid://shopify/Product/"+e.value;return console.log("[A/B Test] Product ID detected:",t,"(via cart form - may be variant ID)"),t}}const o=window.location.pathname.match(/\/products\/([^\/]+)/);if(o&&o[1]){const e="handle:"+o[1];return console.log("[A/B Test] Product ID detected:",e,"(via URL - handle only)"),e}return console.warn("[A/B Test] Could not detect product ID using any strategy"),t("Available globals:",{ShopifyAnalytics:!!window.ShopifyAnalytics,__st:!!window.__st,metaTags:document.querySelectorAll('meta[property*="product"]').length}),null}function r(e){if(!e||!e.offsetParent)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility||"0"===t.opacity)return!1;const n=e.getBoundingClientRect();return 0!==n.width&&0!==n.height}function c(e){let n=0;if(!r(e))return-1e3;const o=e.getBoundingClientRect(),i=e.src||e.dataset.src||"",s=o.width*o.height;n+=Math.min(s/1e3,500),(i.includes("/products/")||i.includes("cdn.shopify.com"))&&(n+=100),(i.includes("_grande")||i.includes("_large")||i.includes("_1024x"))&&(n+=50),(i.includes("_thumb")||i.includes("_small")||i.includes("_icon"))&&(n-=100);const a=window.pageYOffset||document.documentElement.scrollTop;o.top+a<1e3&&(n+=50);let c=e;for(let e=0;e<5&&c;e++){c.classList&&Array.from(c.classList).join(" ");const e=c.className||"";/product|gallery|media|featured|main|primary/i.test(e)&&(n+=30),/slider|carousel|swiper|slick|flickity/i.test(e)&&(n+=20),/thumb|thumbnail|nav|navigation|breadcrumb|footer|header/i.test(e)&&(n-=50),c=c.parentElement}return(e.dataset.productImage||e.dataset.productFeaturedImage)&&(n+=50),t("Image score:",n,"src:",i.substring(0,60),"size:",o.width,"x",o.height),n}function l(e){if(!e)return;e.dataset.abTestHidden="true",e.style.display="none",e.style.visibility="hidden";let n=e.parentElement,o=0;for(;n&&o<3;){const e=n.className||"";if(/media-item|slide|photo-item|image-item|gallery-item/i.test(e)){n.style.display="none",n.dataset.abTestHidden="true",t("Hiding parent container:",e);break}n=n.parentElement,o++}}function d(e,t){e&&(e.dataset.originalSrc||(e.dataset.originalSrc=e.src),e.src=t,e.srcset&&(e.dataset.originalSrcset=e.srcset,e.srcset=""),e.dataset.src&&(e.dataset.originalDataSrc=e.dataset.src,e.dataset.src=t),"lazy"===e.loading&&(e.loading="eager"),e.style.display="",e.style.visibility="",e.dataset.abTestReplaced="true")}function u(e){if(!e||!e.length)return!1;if(i)return t("Skipping replaceImages - already in progress"),!1;const n=e.join("|");if(s.has(n))return t("Skipping replaceImages - already processed these URLs"),!0;i=!0,s.add(n);try{let n=0,o=0,i=0;const s=function(){const e=[".product__media-list",".product-media-gallery",".product__media-wrapper",".product__media-list",".product__media-wrapper",".product-single__photos",".product__main-photos",".product__slides",".product-gallery",".product-images",".product-photos","[data-product-images]","[data-product-gallery]",".gallery",".image-gallery"];for(const n of e){const e=document.querySelector(n);if(e){const o=e.querySelectorAll("img");if(o.length>=2)return t("Found gallery container:",n,"with",o.length,"images"),{container:e,images:Array.from(o)}}}const n=Array.from(document.querySelectorAll("img")).filter(e=>{const t=e.src||e.dataset.src||"";return t.includes("/products/")||t.includes("cdn.shopify.com")});if(n.length>=2){let e=n[0].parentElement,o=0;const i=5;for(;e&&o<i;){const i=e.querySelectorAll("img");if(i.length>=.8*n.length)return t("Found common parent container with",i.length,"images"),{container:e,images:Array.from(i)};e=e.parentElement,o++}}return t("No gallery container found"),null}();if(s&&s.images.length>0){t("Using gallery-based approach with",s.images.length,"images");const a=s.images.filter(e=>r(e));t("Visible images in gallery:",a.length),a.forEach((s,a)=>{if(a<e.length){const o=r(s);d(s,e[a]),n++,o&&i++,t("Replaced gallery image",a,"visible:",o)}else l(s),o++,t("Hiding extra gallery image",a)});s.images.filter(e=>!r(e)).forEach(e=>{e.dataset.abTestReplaced||l(e)})}else{t("Using intelligent scoring approach (no gallery container found)");(function(){const e=Array.from(document.querySelectorAll("img")).map(e=>({img:e,score:c(e)})).filter(e=>e.score>0).sort((e,t)=>t.score-e.score);return t("Found",e.length,"potential product images"),e.map(e=>e.img)})().forEach((s,a)=>{if(a<e.length){const o=r(s);d(s,e[a]),n++,o&&i++,t("Replaced image (scoring)",a,"visible:",o)}else l(s),o++,t("Hiding extra image (scoring)",a)})}return console.log("[A/B Test] Replacement summary:",{replaced:n,visible:i,hidden:o,expected:e.length}),n>0&&function(e){if(!window.MutationObserver)return;let n,o=0;const i=3,s=new MutationObserver(function(a){if(o>=i)return t("Observer reached max triggers, disconnecting"),void s.disconnect();let r=!1;for(const e of a){if("childList"===e.type)for(const t of e.addedNodes)if("IMG"===t.tagName||t.querySelectorAll&&t.querySelectorAll("img").length>0){r=!0;break}if(r)break}r?(o++,t("Observer detected new images, trigger count:",o),clearTimeout(n),n=setTimeout(function(){u(e)},100)):t("No new images detected, skipping")});s.observe(document.body,{childList:!0,subtree:!0}),setTimeout(function(){t("Observer timeout reached, disconnecting"),s.disconnect()},5e3)}(e),i>0}finally{i=!1}}async function g(e,o=1){const i=function(){let e=localStorage.getItem(n);return e?t("Existing session ID:",e):(e="session_"+Math.random().toString(36).substr(2,16)+Date.now().toString(36),localStorage.setItem(n,e),t("New session ID created:",e)),e}(),s=new URLSearchParams(window.location.search).get("variant");let a="/apps/model-swap/variant/"+encodeURIComponent(e)+"?session="+i;!s||"a"!==s.toLowerCase()&&"b"!==s.toLowerCase()||(a+="&force="+s.toUpperCase(),console.log("[A/B Test] üîß Forcing variant:",s.toUpperCase())),t("Fetching variant from:",a,"Attempt:",o);try{const e=await fetch(a,{method:"GET",headers:{Accept:"application/json"}});if(t("Response status:",e.status),!e.ok)throw new Error("HTTP "+e.status);const n=await e.json();return t("Variant data received:",n),n}catch(n){return o<3?(t("Retrying... attempt",o+1),await new Promise(e=>setTimeout(e,100*o)),g(e,o+1)):(console.error("[A/B Test] Failed to fetch variant after",3,"attempts:",n),null)}}async function m(){if(console.log("[A/B Test] Initializing on page:",window.location.pathname),!window.location.pathname.includes("/products/"))return void t("Not a product page, skipping A/B test");const e=a();if(e)try{const n=await g(e);if(n&&n.variant&&n.imageUrls&&n.testId){console.log("[A/B Test] Active test found:",n.testId,"Variant:",n.variant,"Images:",n.imageUrls.length);u(n.imageUrls)?(sessionStorage.setItem(o,JSON.stringify({testId:n.testId,variant:n.variant,productId:e})),console.log("[A/B Test] ‚úÖ Visible images replaced successfully")):(console.warn("[A/B Test] ‚ö†Ô∏è Failed to replace visible images"),console.warn("[A/B Test] This may indicate theme compatibility issues"),console.warn("[A/B Test] Enable debug mode with ?ab_debug=true for detailed logs"),t("Image URLs attempted:",n.imageUrls))}else console.log("[A/B Test] No active test for this product"),t("API response:",n)}catch(e){console.error("[A/B Test] ‚ùå Initialization failed:",e)}}console.log("[A/B Test] Script loaded and initialized",e?"(debug mode ON)":""),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):setTimeout(m,0),window.addEventListener("load",function(){const e=sessionStorage.getItem(o);if(e)try{const t=JSON.parse(e);setTimeout(function(){const e=a();e===t.productId&&g(e).then(function(e){e&&e.imageUrls&&u(e.imageUrls)})},100)}catch(e){}})}();