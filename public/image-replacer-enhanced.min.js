!function(){"use strict";const e=window.location.search.includes("ab_debug=true"),t="/apps/model-swap",o="ab_test_session",s="ab_test_session_meta",i="ab_test_active";let r=!1;const a=new Set;let n=null,c=null;const l={dawn:{name:"Dawn",detection:{selectors:[".product__media-list","media-gallery","#MainProduct"],attributes:['data-section="main-product"'],classes:["product__media-item","product__media-wrapper"]},gallery:{containers:[".product__media-list","ul.product__media-list","media-gallery .product__media-list"],items:[".product__media-item","li.product__media-item",".product__media-list > li"],images:[".product__media img",".product__media-item img",".product-media-container img"]},hiding:{strategy:"item",method:"display",cleanupSelectors:[".product__media-wrapper:empty"]}},horizon:{name:"Horizon",detection:{selectors:["media-gallery","slideshow-component","slideshow-slide"],attributes:["data-presentation"],classes:["media-gallery","slideshow-slide","product-media-container"]},gallery:{containers:["slideshow-slides","media-gallery","slideshow-container"],items:["slideshow-slide",".product-media-container"],images:["slideshow-slide img",".product-media__image",".product-media img"]},hiding:{strategy:"item",method:"display",cleanupSelectors:[]}},debut:{name:"Debut",detection:{selectors:[".product-single__photos","#ProductPhoto"],attributes:[],classes:["product-single__photo"]},gallery:{containers:[".product-single__photos",".product__main-photos"],items:[".product-single__photo",".product-single__photo-wrapper"],images:[".product-single__photo img"]},hiding:{strategy:"item",method:"visibility",cleanupSelectors:[]}},brooklyn:{name:"Brooklyn",detection:{selectors:[".product__slides"],attributes:[],classes:["product__slide"]},gallery:{containers:[".product__slides"],items:[".product__slide"],images:[".product__slide img"]},hiding:{strategy:"item",method:"display",cleanupSelectors:[]}},prestige:{name:"Prestige",detection:{selectors:[".Product__Gallery",".Product__Slideshow"],attributes:[],classes:["Product__SlideItem"]},gallery:{containers:[".Product__Gallery",".Product__Slideshow"],items:[".Product__SlideItem"],images:[".Product__SlideItem img",".Image--lazyLoad"]},hiding:{strategy:"item",method:"display",cleanupSelectors:[]}},impulse:{name:"Impulse",detection:{selectors:[".product__photos"],attributes:[],classes:["product__photo"]},gallery:{containers:[".product__photos"],items:[".product__photo"],images:[".product__photo img"]},hiding:{strategy:"item",method:"display",cleanupSelectors:[]}},turbo:{name:"Turbo",detection:{selectors:[".product-images",".product-gallery"],attributes:[],classes:["product-image","gallery-cell"]},gallery:{containers:[".product-images",".product-gallery"],items:[".product-image",".gallery-cell"],images:[".product-image img",".gallery-cell img"]},hiding:{strategy:"item",method:"display",cleanupSelectors:[]}},narrative:{name:"Narrative",detection:{selectors:[".product__images"],attributes:[],classes:["product__image"]},gallery:{containers:[".product__images"],items:[".product__image"],images:[".product__image img"]},hiding:{strategy:"item",method:"display",cleanupSelectors:[]}}};function d(...t){e&&console.log("[A/B Test Debug]",...t)}function u(){if(n)return n;console.log("[A/B Test] Starting advanced theme detection...");const e={};for(const[t,o]of Object.entries(l)){let s=0;for(const e of o.detection.selectors)document.querySelector(e)&&(s+=10,d(`Theme ${o.name}: Found selector ${e} (+10)`));for(const e of o.detection.attributes)document.querySelector(`[${e}]`)&&(s+=5,d(`Theme ${o.name}: Found attribute ${e} (+5)`));for(const e of o.detection.classes)document.getElementsByClassName(e).length>0&&(s+=3,d(`Theme ${o.name}: Found class ${e} (+3)`));s>0&&(e[t]=s)}let t=null,o=0;for(const[s,i]of Object.entries(e))i>o&&(o=i,t=s);return t?(n=t,c=l[t],console.log(`[A/B Test] Theme detected: ${c.name} (confidence score: ${o})`)):(n="adaptive",c=null,console.log("[A/B Test] No specific theme detected, using adaptive mode")),n}function m(){u();if(c){d(`Attempting ${c.name} theme-specific gallery detection`);for(const e of c.gallery.containers){const t=document.querySelector(e);if(t){const o=g(t,c);if(o)return console.log(`[A/B Test] Gallery found using ${c.name} selector: ${e}`),o}}}return function(){d("Using adaptive gallery detection");const e=["media-gallery","product-gallery","slider-component",'[class*="product"][class*="media"]','[class*="product"][class*="gallery"]','[class*="product"][class*="image"]','[class*="product"][class*="photo"]','[class*="product"][class*="slide"]',"[data-product-images]","[data-product-gallery]","[data-media-gallery]","[data-gallery]",'ul[class*="product"]','div[class*="swiper"]','div[class*="slider"]','div[class*="carousel"]'];for(const t of e)try{const e=document.querySelectorAll(t);for(const o of e){const e=g(o,null);if(e)return d(`Gallery found using adaptive pattern: ${t}`),e}}catch(e){}return function(){d("Using common parent detection");const e=Array.from(document.querySelectorAll("img")).filter(h);if(e.length<2)return null;let t=e[0].parentElement,o=10,s=0;for(;t&&s<o;){const o=e.filter(e=>t.contains(e));if(o.length>=.8*e.length){const e=o.map(e=>({img:e,item:p(e,t)}));return{container:t,images:e,items:[],theme:"common-parent",structured:!1}}t=t.parentElement,s++}return null}()}()}function g(e,t){let o=[],s=[];if(t&&t.gallery.items){const i=t.gallery.items.join(","),r=Array.from(e.querySelectorAll(i));r.length>0&&r.forEach(e=>{const t=e.querySelector("img");t&&h(t)&&(o.push({img:t,item:e}),s.push(e))})}if(0===o.length){e.querySelectorAll("img").forEach(e=>{h(e)&&o.push({img:e,item:e.parentElement})})}return o.length>=2?{container:e,images:o,items:s,theme:t?t.name:"adaptive",structured:s.length>0}:null}function p(e,t){let o=e.parentElement,s=o;for(;o&&o!==t;){(o.className||"").match(/item|slide|cell|wrapper|container/i)&&(s=o),o=o.parentElement}return s}function h(e){const t=e.src||e.dataset.src||"";if(t.includes("/products/")||t.includes("cdn.shopify.com")||t.includes("/cdn/shop/files/")||t.includes(".myshopify.com/cdn/")){const t=e.naturalWidth||e.offsetWidth||e.getBoundingClientRect().width,o=e.naturalHeight||e.offsetHeight||e.getBoundingClientRect().height;if(t>50||o>50)return!0}return!1}function y(e,t){if(!e||!e.length)return!1;if(r)return d("Already replacing images"),!1;const o=e.join("|");if(a.has(o))return d("Already processed these URLs"),!0;r=!0,a.add(o);try{console.log(`[A/B Test] Starting image replacement (${e.length} images)`);const t=m();if(!t)return console.error("[A/B Test] No gallery found"),!1;console.log(`[A/B Test] Gallery found: ${t.theme} mode, ${t.images.length} images`);let o=0,s=0;return t.images.forEach((t,i)=>{i<e.length?function(e,t,o){const{img:s,item:i}=e;if(!s)return!1;s.dataset.originalSrc||(s.dataset.originalSrc=s.src,s.srcset&&(s.dataset.originalSrcset=s.srcset),s.dataset.src&&(s.dataset.originalDataSrc=s.dataset.src));s.src=t,s.srcset="",s.dataset.src&&(s.dataset.src=t);"lazy"===s.loading&&(s.loading="eager");s.dataset.abTestReplaced="true",s.dataset.abTestIndex=o.toString(),s.style.removeProperty("display"),s.style.removeProperty("visibility"),s.style.removeProperty("opacity"),i&&i!==s&&(i.style.removeProperty("display"),i.style.removeProperty("visibility"),i.dataset.abTestVisible="true");return d(`Replaced image ${o}`),!0}(t,e[i],i)&&o++:function(e,t){const{img:o,item:s}=e,i=c||{hiding:{strategy:"both",method:"display"}},r="image"!==i.hiding.strategy&&s?s:o;if(!r)return!1;if(i&&"Horizon"===i.name){r.style.cssText="display: none !important; visibility: hidden !important;",r.setAttribute("aria-hidden","true"),r.setAttribute("hidden","");const e=r.closest("slideshow-slide");e&&e!==r&&(e.style.cssText="display: none !important; visibility: hidden !important;",e.setAttribute("aria-hidden","true"),e.setAttribute("hidden",""),e.dataset.abTestHidden="true")}else switch(i.hiding.method){case"remove":r.remove();break;case"visibility":r.style.visibility="hidden",r.style.position="absolute",r.style.left="-9999px";break;default:r.style.display="none"}return r.dataset.abTestHidden="true",r.dataset.abTestIndex=t.toString(),d(`Hidden image ${t} using ${i.hiding.method||"Horizon aggressive"}`),!0}(t,i)&&s++}),function(){if(!c||!c.hiding.cleanupSelectors)return;c.hiding.cleanupSelectors.forEach(e=>{document.querySelectorAll(e).forEach(t=>{Array.from(t.children).some(e=>"true"!==e.dataset.abTestHidden&&"none"!==e.style.display)||(t.style.display="none",d("Hidden empty container:",e))})})}(),console.log(`[A/B Test] âœ… Replacement complete: ${o} replaced, ${s} hidden`),o>0&&function(e){if(!window.MutationObserver)return;let t;const o=new MutationObserver(()=>{clearTimeout(t),t=setTimeout(()=>{d("Re-applying images after DOM mutation"),y(e)},100)});o.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>o.disconnect(),5e3)}(e),o>0}finally{r=!1}}function f(){const e=sessionStorage.getItem(i);if(!e)return null;try{const t=JSON.parse(e);if(t&&t.testId&&t.productId&&("A"===t.variant||"B"===t.variant))return t}catch(e){d("Failed to parse active test data")}return null}function _(){const e=Date.now();let t,i=localStorage.getItem(o);try{t=JSON.parse(localStorage.getItem(s)||"{}")}catch{t={}}if(t.id&&t.createdAt){if(e-Number(t.createdAt)<432e5)return t.id}return i="session_"+Math.random().toString(36).substr(2,16)+e.toString(36),t={id:i,createdAt:e},localStorage.setItem(o,i),localStorage.setItem(s,JSON.stringify(t)),d("New session created:",i),i}function b(){const e=[()=>window.ShopifyAnalytics?.meta?.product?.gid,()=>window.__st?.rid?`gid://shopify/Product/${window.__st.rid}`:null,()=>{const e=document.querySelector('meta[property="og:product:id"]');return e?.content?`gid://shopify/Product/${e.content}`:null},()=>{const e=window.location.pathname.match(/\/products\/([^\/]+)/);return e?.[1]?`handle:${e[1]}`:null}];for(const t of e){const e=t();if(e)return console.log("[A/B Test] Product ID:",e),e}return console.warn("[A/B Test] Could not detect product ID"),null}async function T(e,o=1){const s=_(),i=new URLSearchParams(window.location.search).get("variant");let r=`${t}/variant/${encodeURIComponent(e)}?session=${s}`;i&&/^[ab]$/i.test(i)&&(r+=`&force=${i.toUpperCase()}`,console.log("[A/B Test] Forcing variant:",i.toUpperCase()));try{const e=await fetch(r,{method:"GET",headers:{Accept:"application/json","X-AB-Session":s.substring(0,32)}});if(!e.ok)throw new Error(`HTTP ${e.status}`);return await e.json()}catch(t){if(o<3)return await new Promise(e=>setTimeout(e,100*o)),T(e,o+1);throw t}}async function w(e,o={}){const s=f();if(!s)return console.warn("[A/B Test] No active test for tracking"),!1;const i=_(),r={testId:s.testId,sessionId:i,eventType:e,productId:s.productId,variant:s.variant,...o};console.log("[A/B Test] Sending tracking event:",e);try{return(await fetch(`${t}/track`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).ok}catch(e){return console.error("[A/B Test] Tracking failed:",e),!1}}function v(){const e=document.querySelectorAll('form[action*="/cart/add"]'),t=document.querySelectorAll(['button[name="add"]',"button[data-add-to-cart]",".product-form__submit",".add-to-cart","#AddToCart"].join(","));e.forEach(e=>{e.dataset.abTracked||(e.dataset.abTracked="true",e.addEventListener("submit",()=>{w("ADD_TO_CART",{source:"form"})}))}),t.forEach(e=>{e.dataset.abTracked||(e.dataset.abTracked="true",e.addEventListener("click",()=>{setTimeout(()=>{w("ADD_TO_CART",{source:"button"})},0)}))}),d(`Wired tracking: ${e.length} forms, ${t.length} buttons`)}async function S(){console.log("[A/B Test] Initializing enhanced image replacer"),console.log("[A/B Test] Debug mode:",e?"ON":"OFF");const t=u();if(console.log("[A/B Test] Theme:",t),!window.location.pathname.includes("/products/"))return void d("Not a product page");const o=b();if(o)try{const e=await T(o);if(e?.variant&&e?.imageUrls?.length&&e?.testId){console.log("[A/B Test] Test active:",{testId:e.testId,variant:e.variant,images:e.imageUrls.length});y(e.imageUrls,e.variant)?(sessionStorage.setItem(i,JSON.stringify({testId:e.testId,variant:e.variant,productId:o})),v(),setTimeout(v,1e3),setTimeout(v,3e3)):console.warn("[A/B Test] Failed to replace images")}else console.log("[A/B Test] No active test")}catch(e){console.error("[A/B Test] Init failed:",e)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",S):setTimeout(S,0),window.addEventListener("load",()=>{const e=f();e&&setTimeout(()=>{const t=b();t===e.productId&&T(t).then(e=>{e?.imageUrls&&y(e.imageUrls,e.variant)})},100)}),window.__abTest={detectTheme:u,findGalleryContainer:m,replaceImages:y,DEBUG_MODE:e,version:"2.0.0"}}();